<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STEAM Tool Detector</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Teachable Machine and TensorFlow -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
    <!-- Th∆∞ vi·ªán chuy·ªÉn ƒë·ªïi Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked@12.0.2/lib/marked.umd.min.js"></script> 
    <style>
        /* Custom font and basic setup */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        /* Style for the chat box */
        .chat-message {
            padding: 8px 12px;
            border-radius: 12px;
            margin-bottom: 8px;
            max-width: 80%;
            word-wrap: break-word;
        }
        .user-message {
            background-color: #dbeafe; /* Blue-100 */
            align-self: flex-end;
            margin-left: auto;
        }
        .ai-message {
            background-color: #f3f4f6; /* Gray-100 */
            align-self: flex-start;
        }
        /* Custom styles for info display */
        #info-display h3 {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: #1f2937; /* Gray-800 */
        }
        #info-display strong {
            color: #10b981; /* Emerald-500 */
        }
        #info-display ul {
            list-style-type: disc;
            margin-left: 1.5rem;
            padding-left: 0;
            margin-top: 0.5rem;
        }
        #info-display li {
            margin-bottom: 0.25rem;
        }
        /* Highlight for dangerous tools */
        .ask-teacher {
            color: #ef4444; /* Red-500 */
            font-weight: bold;
            font-size: 0.9em;
            margin-left: 8px;
        }
    </style>
</head>
<body>

    <div class="min-h-screen p-4 sm:p-8 flex flex-col items-center">
        <!-- Header -->
        <header class="w-full max-w-4xl text-center mb-8">
            <h1 class="text-4xl font-extrabold text-blue-700 tracking-tight">STEAM Lab Tool Inspector</h1>
            <p class="text-gray-500 mt-2 text-lg">Identify tools and learn how to use them safely.</p>
        </header>

        <!-- Main Content Grid -->
        <div id="app-container" class="w-full max-w-4xl grid grid-cols-1 lg:grid-cols-2 gap-8">

            <!-- Detection Panel (Left/Top) -->
            <div class="bg-white p-6 rounded-xl shadow-2xl transition-all duration-300">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.55 4.55a.5.5 0 010 .71l-5.86 5.86a.5.5 0 01-.71 0L4.55 15a.5.5 0 010-.71l5.86-5.86a.5.5 0 01.71 0L15 10zM12 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    1. Scan a Tool
                </h2>

                <!-- Control Button -->
                <button type="button" onclick="init()" id="start-button"
                    class="w-full py-3 mb-4 text-white font-bold bg-green-500 hover:bg-green-600 rounded-lg transition duration-150 ease-in-out shadow-md hover:shadow-lg focus:outline-none focus:ring-4 focus:ring-green-300">
                    Start Camera & Model
                </button>

                <!-- Loading/Webcam Container -->
                <div id="webcam-container" class="w-full aspect-video flex justify-center items-center bg-gray-100 rounded-lg overflow-hidden">
                    <p id="loading-message" class="text-gray-500 text-center">Press 'Start Camera & Model' above.</p>
                </div>

                <!-- Label Container (Predictions - Now displays ONLY the best name and the info button) -->
                <div id="label-container" class="mt-4 p-3 bg-blue-100 rounded-lg hidden flex justify-between items-center">
                    <span id="detected-tool-name" class="text-lg font-bold text-gray-800">No Tool Detected</span>
                    <button type="button" onclick="generateExplanation('manual')" id="info-button" disabled
                        class="px-4 py-2 text-white font-semibold bg-blue-500 rounded-lg transition duration-150 ease-in-out shadow-md hover:bg-blue-600 disabled:bg-gray-400 disabled:cursor-not-allowed">
                        Get Tool Info ‚ÑπÔ∏è
                    </button>
                </div>
            </div>

            <!-- Information Panel (Right/Bottom) -->
            <div class="bg-white p-6 rounded-xl shadow-2xl transition-all duration-300">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    2. Tool Information & Safety
                </h2>

                <div id="info-display" class="p-4 bg-yellow-50 border-l-4 border-yellow-500 rounded-lg min-h-64">
                    <p class="text-gray-600 italic">Information will appear here after you scan a tool and click 'Get Tool Info'.</p>
                </div>
            </div>

        </div>
        
        <!-- Custom Q&A Chat Panel (New Gemini Feature) -->
        <div class="w-full max-w-4xl mt-8 bg-white p-6 rounded-xl shadow-2xl transition-all duration-300">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800 flex items-center">
                <span class="text-pink-500 mr-2">‚ú®</span> 3. Ask the STEAM AI
            </h2>

            <!-- Chat History -->
            <div id="chat-history" class="h-64 overflow-y-auto p-4 mb-4 border rounded-lg bg-gray-50 flex flex-col space-y-2">
                <div class="ai-message chat-message">Hello! Ask me any question about the detected tool or STEAM topics.</div>
            </div>

            <!-- Chat Input -->
            <div class="flex space-x-3">
                <input type="text" id="chat-input" placeholder="E.g., What is a simple project I can make with a hammer?"
                    class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                    onkeydown="if(event.key === 'Enter') document.getElementById('ask-button').click()">
                <button type="button" onclick="askAI()" id="ask-button"
                    class="px-5 py-3 text-white font-semibold bg-pink-500 hover:bg-pink-600 rounded-lg transition duration-150 ease-in-out shadow-md focus:outline-none focus:ring-4 focus:ring-pink-300 disabled:bg-gray-400">
                    Ask ‚ú®
                </button>
            </div>
        </div>
    </div>


    <script>
        // --- Configuration ---
        const URL = "https://teachablemachine.withgoogle.com/models/KKMgqPodwM/";
        const CONFIDENCE_THRESHOLD = 0.7; // Minimum probability to consider a tool 'detected'
        
        // CH·ªà S·ª¨ D·ª§NG BASE URL. H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông th√™m API Key.
        const API_BASE_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent';
        const apiKey = ""; 

        // Danh s√°ch c√°c c√¥ng c·ª• c·∫ßn c·∫£nh b√°o (d√πng ch·ªØ hoa ho·∫∑c ch·ªØ th∆∞·ªùng ƒë·ªÉ kh·ªõp v·ªõi t√™n l·ªõp trong Teachable Machine)
        const TEACHER_CONSULTATION_TOOLS = [
            "Knife", 
            "Rotary cutter", 
            "Measure tape", 
            "Wrench",
            "knife", 
            "rotary cutter", 
            "measure tape", 
            "wrench"
        ].map(s => s.toLowerCase());


        let model, webcam, maxPredictions;
        let isRunning = false;
        let lastDetectedClass = "Background Noise"; // Stores the name of the best prediction
        let isGeminiRunning = false; // Flag to prevent concurrent calls

        const infoButton = document.getElementById('info-button');
        const infoDisplay = document.getElementById("info-display");

        // --- Helper Functions ---
        function appendMessage(sender, text) {
            const history = document.getElementById('chat-history');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}-message`;
            messageDiv.textContent = text;
            history.appendChild(messageDiv);
            // Scroll to the bottom
            history.scrollTop = history.scrollHeight;
        }

        // H√†m h·ªó tr·ª£ backoff (cho Gemini API)
        const maxRetries = 3;
        async function fetchWithExponentialBackoff(url, options) {
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    // Do not log 401 errors, as they are handled by the environment
                    if (error.message.includes('401')) {
                         console.error("Authentication error (401). Retrying is unlikely to help.");
                         throw error; 
                    }
                    if (attempt === maxRetries - 1) {
                        throw error;
                    }
                    // Wait before retrying (exponential backoff)
                    const delay = Math.pow(2, attempt) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }
        
        // --- Core Functions: Teachable Machine ---

        async function init() {
            if (isRunning) return;
            isRunning = true;

            const modelURL = URL + "model.json";
            const metadataURL = URL + "metadata.json";
            const startButton = document.getElementById("start-button");
            const loadingMessage = document.getElementById("loading-message");
            const webcamContainer = document.getElementById("webcam-container");
            const labelContainer = document.getElementById("label-container");


            startButton.disabled = true;
            startButton.textContent = "Loading Model & Camera...";
            loadingMessage.textContent = "Loading Teachable Machine model...";
            labelContainer.classList.remove('hidden'); // Show the detection status box

            try {
                // Load model
                model = await tmImage.load(modelURL, metadataURL);
                maxPredictions = model.getTotalClasses();
                loadingMessage.textContent = "Model loaded. Setting up camera...";

                // Setup webcam
                const flip = true; 
                webcam = new tmImage.Webcam(400, 300, flip); 
                await webcam.setup(); 
                await webcam.play();

                // Append elements to the DOM
                webcamContainer.innerHTML = ''; 
                webcamContainer.appendChild(webcam.canvas);
                webcam.canvas.className = "w-full h-auto rounded-lg shadow-lg";

                startButton.textContent = "Camera Running";
                startButton.classList.remove('bg-green-500', 'hover:bg-green-600', 'focus:ring-green-300');
                startButton.classList.add('bg-gray-400', 'cursor-default');

                // Initial UI state
                document.getElementById('detected-tool-name').textContent = "Waiting for tool...";
                infoButton.disabled = true;

                // Start the prediction loop
                window.requestAnimationFrame(loop);
                
            } catch (error) {
                console.error("Initialization failed:", error);
                loadingMessage.textContent = "Error: Could not load model or access camera. Please check permissions.";
                startButton.textContent = "Start Camera & Model (Error)";
                startButton.disabled = false;
                isRunning = false;
                labelContainer.classList.add('hidden');
            }
        }

        async function loop() {
            if (!isRunning) return;
            webcam.update(); 
            await predict();
            window.requestAnimationFrame(loop);
        }

        // Run the webcam image through the image model
        async function predict() {
            const prediction = await model.predict(webcam.canvas);
            
            // Sort predictions by probability (descending)
            prediction.sort((a, b) => b.probability - a.probability);

            const bestPrediction = prediction[0];
            const detectedNameElement = document.getElementById('detected-tool-name');
            
            let newDetectedClass = "Background Noise";
            
            // Check if the best prediction meets the confidence threshold
            if (bestPrediction.probability >= CONFIDENCE_THRESHOLD) {
                newDetectedClass = bestPrediction.className;
                
                let displayText = newDetectedClass;
                
                // --- LOGIC M·ªöI: Th√™m c·∫£nh b√°o cho c√¥ng c·ª• nguy hi·ªÉm ---
                if (TEACHER_CONSULTATION_TOOLS.includes(newDetectedClass.toLowerCase())) {
                    displayText += '<span class="ask-teacher">(Ask Teacher Before Use!)</span>';
                }
                
                detectedNameElement.innerHTML = displayText;
                infoButton.disabled = false;
                infoButton.classList.remove('bg-gray-400');
                infoButton.classList.add('bg-blue-500', 'hover:bg-blue-600');
                
            } else {
                newDetectedClass = "Background Noise";
                detectedNameElement.textContent = "No Tool Detected";
                infoButton.disabled = true;
                infoButton.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                infoButton.classList.add('bg-gray-400');
            }

            // Update the stored class only if it changes (for the info button)
            if (newDetectedClass !== lastDetectedClass) {
                lastDetectedClass = newDetectedClass;
            }
        }
        
        // --- Gemini API Call: Structured Tool Info (Feature 1) ---
        // ƒê√£ ƒë·ªïi t√™n th√†nh generateExplanation v√† lo·∫°i b·ªè JSON schema
        async function generateExplanation(source = 'manual') {
            const currentClass = lastDetectedClass;
            // Prevent searching for 'Background Noise'
            if (currentClass === "Background Noise" || !currentClass || isGeminiRunning) return; 

            isGeminiRunning = true; // Set flag to prevent concurrent calls
            
            // Show loading state
            const loadingHtml = `
                <div class="flex flex-col items-center justify-center p-8 min-h-64">
                    <svg class="animate-spin h-8 w-8 text-blue-500" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="mt-4 text-blue-500 font-semibold">Searching for safety guide on "${currentClass}"...</p>
                    <p class="text-sm text-gray-500 mt-1">This may take a few seconds.</p>
                </div>`;
            
            infoDisplay.innerHTML = loadingHtml;
            infoDisplay.classList.remove('border-yellow-500', 'border-green-500');
            infoDisplay.classList.add('border-blue-500');
            infoButton.disabled = true;
            infoButton.textContent = "Loading...";

            const systemPrompt = `You are a friendly and precise STEAM Lab safety expert. Your task is to provide concise information about the tool suitable for Grade 7 and 8 students. Your response must include:
            1. The name of the tool and a short, one-sentence description.
            2. A section titled "HOW TO USE IT üõ†Ô∏è" with 3-4 simple, clear steps for usage.
            3. A section titled "SAFETY RULES ‚ö†Ô∏è" with 3-4 crucial safety rules, emphasizing eye protection and careful handling.
            Format the response clearly using Markdown headings and bullet lists.`;
            
            const userQuery = `Find and summarize the usage and safety guidelines for the tool named: "${currentClass}".`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }], // Enable Google Search
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };
            
            const apiUrl = API_BASE_URL;

            try {
                const response = await fetchWithExponentialBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                
                const candidate = result.candidates?.[0];
                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const markdownText = candidate.content.parts[0].text;
                    displayToolInfo(markdownText, candidate.groundingMetadata);
                } else {
                    infoDisplay.innerHTML = `<p class="text-red-600 font-bold p-4">‚ùå Error: Could not generate tool information.</p>`;
                    infoDisplay.classList.remove('border-blue-500');
                    infoDisplay.classList.add('border-red-500');
                }
                
            } catch (error) {
                console.error("Gemini API Error:", error);
                infoDisplay.innerHTML = `
                    <p class="text-red-600 font-bold p-4">‚ùå Error: API connection failed after retries.</p>
                    <p class="text-gray-600 italic px-4 pb-4">Please check your network or try again later.</p>`;
                infoDisplay.classList.remove('border-blue-500');
                infoDisplay.classList.add('border-red-500');
            } finally {
                isGeminiRunning = false;
                infoButton.disabled = false;
                infoButton.textContent = "Get Tool Info ‚ÑπÔ∏è";
            }
        }

        // Renders the tool information into the right panel using Markdown
        function displayToolInfo(markdownText, groundingMetadata) {
            
            // 1. Convert Markdown to HTML
            const htmlContent = marked.parse(markdownText);
            
            // 2. Extract and format sources (references)
            let sourcesHtml = '';
            if (groundingMetadata && groundingMetadata.groundingAttributions) {
                const sources = groundingMetadata.groundingAttributions
                    .map(attribution => ({
                        uri: attribution.web?.uri,
                        title: attribution.web?.title,
                    }))
                    .filter(source => source.uri && source.title);

                if (sources.length > 0) {
                    sourcesHtml = '<div class="mt-4 pt-2 border-t border-gray-200 text-xs text-gray-500">';
                    sourcesHtml += 'Source(s): ';
                    sourcesHtml += sources.slice(0, 3).map(s => `<a href="${s.uri}" target="_blank" class="text-blue-500 hover:underline">${s.title}</a>`).join(' | ');
                    sourcesHtml += '</div>';
                }
            }

            // 3. Update the display container
            infoDisplay.innerHTML = `<div class="p-2">${htmlContent}</div>${sourcesHtml}`;
            infoDisplay.classList.remove('border-yellow-500', 'border-blue-500', 'border-red-500');
            infoDisplay.classList.add('border-green-500'); 
        }

        // --- Gemini API Call: Custom Q&A (Feature 2) ---

        async function askAI() {
            const inputElement = document.getElementById('chat-input');
            const askButton = document.getElementById('ask-button');
            const userQuery = inputElement.value.trim();

            if (!userQuery) return;

            // Display user message and clear input
            appendMessage('user', userQuery);
            inputElement.value = '';
            askButton.disabled = true;

            // Display AI loading message
            appendMessage('ai', '...');
            const history = document.getElementById('chat-history');
            const aiLoadingMessage = history.lastChild;

            // System prompt for the chat feature
            const systemPrompt = "You are a helpful and engaging STEAM tutor for Grade 7/8 students. Answer questions concisely and use simple language. If the user asks about the currently detected tool, integrate that knowledge into your answer. The currently detected tool is: " + lastDetectedClass;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }], // Use search grounding for accurate answers
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };
            
            // CH·ªà S·ª¨ D·ª§NG BASE URL. H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông th√™m API Key.
            const apiUrl = API_BASE_URL;
            
            let aiResponseText = "Sorry, I couldn't get an answer right now. Please try again.";

            try {
                const response = await fetchWithExponentialBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                
                const candidate = result.candidates?.[0];
                if (candidate && candidate.content?.parts?.[0]?.text) {
                    aiResponseText = candidate.content.parts[0].text;
                }
                
            } catch (error) {
                console.error("AI Chat failed:", error);
            } finally {
                // Remove loading message and display final AI response
                history.removeChild(aiLoadingMessage);
                appendMessage('ai', aiResponseText);
                askButton.disabled = false;
            }
        }

    </script>
</body>
</html>
