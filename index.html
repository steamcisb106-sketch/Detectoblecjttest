<style>
  /* Định nghĩa font chung cho giao diện */
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
  
  body {
    font-family: 'Inter', sans-serif;
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 0;
    padding: 20px;
    background-color: transparent; /* Giữ trong suốt để hòa hợp với nền Google Sites */
    box-sizing: border-box;
  }
  
  .container {
    background-color: #444444; /* Nền xám đậm phù hợp với trang web */
    border-radius: 16px; 
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4); /* Bóng đổ đậm hơn cho nền tối */
    padding: 24px;
    max-width: 400px; 
    width: 100%;
    text-align: center;
    color: #ffffff; /* Màu chữ mặc định là trắng */
  }
  
  h1.title {
    color: #f0f0f0; /* Tiêu đề màu trắng sáng */
    font-size: 1.5rem;
    margin-bottom: 20px;
    font-weight: 700;
  }
  
  /* Styling cho nút Start */
  .start-button {
    background-color: #3b82f6; /* Màu xanh nổi bật */
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 700;
    cursor: pointer;
    transition: background-color 0.3s ease, transform 0.1s ease;
    margin-bottom: 20px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
  }
  
  .start-button:hover {
    background-color: #2563eb;
    transform: translateY(-1px);
  }
  
  .start-button:active {
    background-color: #1d4ed8;
    transform: translateY(1px);
  }
  
  /* Vùng chứa webcam */
  #webcam-container canvas {
    border: 4px solid #666666; /* Viền xám trung tính */
    border-radius: 12px;
    display: block; 
    margin: 0 auto;
    width: 100%; 
    height: auto;
  }
  
  /* Vùng chứa kết quả (Label) */
  #label-container {
    margin-top: 20px;
    padding: 15px;
    background-color: #555555; /* Nền xám nhạt hơn nền chính */
    color: #ffffff; /* Chữ trắng */
    font-size: 1.25rem;
    font-weight: 700;
    border-radius: 12px;
    min-height: 40px; 
    display: flex;
    justify-content: center;
    align-items: center;
    text-transform: uppercase; 
  }

  /* Thêm hiệu ứng loading */
  .loading-message {
    font-style: italic;
    color: #cccccc; /* Màu chữ xám nhạt */
    margin-bottom: 20px;
  }

  /* New styles for Gemini features */
  .gemini-section {
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid #666666; /* Đường viền xám nhạt */
  }
  
  .gemini-button {
    background-color: #f59e0b; /* Màu vàng, nổi bật */
    color: white;
    padding: 10px 15px;
    border: none;
    border-radius: 8px;
    font-size: 0.9rem;
    font-weight: 700;
    cursor: pointer;
    transition: background-color 0.3s ease;
    margin-top: 15px;
  }

  .gemini-button:hover {
    background-color: #d97706;
  }
  .gemini-button:disabled {
    background-color: #fcd34d;
    cursor: not-allowed;
  }

  #gemini-result-container {
    margin-top: 15px;
    padding: 15px;
    background-color: #555555; /* Nền xám nhạt hơn */
    border-radius: 8px;
    text-align: left;
    min-height: 50px;
    line-height: 1.4;
    font-size: 0.9rem;
    color: #f0f0f0; /* Chữ sáng */
  }

  /* Cải thiện hiển thị Markdown: List và Paragraph */
  #gemini-result-container p {
    margin-bottom: 10px;
    line-height: 1.6; /* Tăng khoảng cách dòng */
  }
  #gemini-result-container ul {
    margin-top: 10px;
    margin-bottom: 10px;
    padding-left: 20px;
  }
  #gemini-result-container li {
    margin-bottom: 5px;
    line-height: 1.4;
    font-weight: 400;
  }
  #gemini-result-container strong {
    color: #ffcc66; /* Tô màu vàng sáng cho chữ in đậm */
  }

  .gemini-loading {
    color: #ffcc66; /* Màu vàng sáng */
    font-style: italic;
  }
  .gemini-error {
    color: #ff8888; /* Màu đỏ sáng */
    font-weight: 600;
  }
  .gemini-response {
    color: #ffffff;
  }
  .gemini-sources {
      margin-top: 10px;
      font-size: 0.75rem;
      color: #aaaaaa;
      border-top: 1px dashed #666666;
      padding-top: 5px;
  }
  .gemini-sources a {
      color: #88ccee; /* Xanh da trời nhạt */
      text-decoration: none;
  }
  .gemini-sources a:hover {
      text-decoration: underline;
  }
</style>

<div class="container">
  <h1 class="title">Object Recognition (STEAM Project)</h1>
  <div class="loading-message" id="status-message">Loading model...</div>
  
  <!-- Nút bấm gọi hàm startWebcam() -->
  <button type="button" onclick="startWebcam()" class="start-button" id="start-button" disabled>START</button>
  
  <!-- Vùng hiển thị webcam -->
  <div id="webcam-container"></div>
  
  <!-- Vùng hiển thị kết quả nhận diện -->
  <div id="label-container">-- Waiting for model --</div>

  <!-- PHẦN TÍNH NĂNG GEMINI MỚI -->
  <div class="gemini-section">
      <!-- Nút gọi Gemini API -->
      <button type="button" onclick="generateExplanation()" class="gemini-button" id="generate-button" disabled>
          ✨ Get Info & Safety Guide
      </button>

      <!-- Vùng hiển thị kết quả từ Gemini -->
      <div id="gemini-result-container">
          <p>Press the button after detection to get information and safety guide.</p>
      </div>
  </div>
</div>

<!-- Tải thư viện TensorFlow.js và Teachable Machine Image -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
<!-- Thư viện chuyển đổi Markdown -->
<script src="https://cdn.jsdelivr.net/npm/marked@12.0.2/lib/marked.umd.min.js"></script> 

<script type="text/javascript">
    // the link to your model provided by Teachable Machine export panel
    const URL = "https://teachablemachine.withgoogle.com/models/XMAxIMwQf/";

    // Gemini API Configuration
    const apiKey = ""; // Canvas runtime provides this key
    const geminiApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
    
    let model, webcam, maxPredictions;
    let isModelLoaded = false;
    let labelContainer; 
    let currentDetectedObject = ''; // Stores the detected object name for Gemini

    const statusMessage = document.getElementById('status-message');
    const startButton = document.getElementById('start-button');
    const generateButton = document.getElementById('generate-button');
    const geminiResultContainer = document.getElementById('gemini-result-container');
    
    const modelURL = URL + "model.json";
    const metadataURL = URL + "metadata.json";

    // Hàm hỗ trợ backoff (cho Gemini API)
    const maxRetries = 5;
    const initialDelay = 1000;

    async function fetchWithExponentialBackoff(url, options, retryCount = 0) {
        // Tái tạo URL để đảm bảo apiKey được đính kèm đúng cách hoặc bỏ qua khi rỗng
        let finalUrl = url;
        
        // Chỉ thêm apiKey vào URL nếu nó không rỗng
        if (apiKey) {
            const separator = url.includes('?') ? '&' : '?';
            finalUrl = `${url}${separator}key=${apiKey}`;
        }
        // Ghi chú: Trong môi trường Canvas, Canvas sẽ tự động thêm key,
        // nhưng việc đảm bảo logic URL đúng là rất quan trọng.

        try {
            const response = await fetch(finalUrl, options);
            if (!response.ok) {
                // Throwing error to trigger retry logic
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response;
        } catch (error) {
            if (retryCount < maxRetries) {
                const delay = initialDelay * Math.pow(2, retryCount);
                await new Promise(resolve => setTimeout(resolve, delay));
                return fetchWithExponentialBackoff(url, options, retryCount + 1);
            } else {
                console.error("Failed to fetch after multiple retries:", error);
                throw error;
            }
        }
    }

    // Hàm tải mô hình (Tự động chạy khi trang load)
    async function loadModel() {
        labelContainer = document.getElementById("label-container");
        
        try {
            console.log("Loading model from:", modelURL); // Log for debugging
            model = await tmImage.load(modelURL, metadataURL);
            maxPredictions = model.getTotalClasses();
            isModelLoaded = true;
            statusMessage.innerText = "Model loaded. Press START.";
            startButton.disabled = false; // Enable button after loading
            labelContainer.innerText = "-- Ready --";

        } catch (error) {
            console.error("ERROR LOADING MODEL:", error); // Log specific error
            statusMessage.innerText = "ERROR: Could not load model. Please check the URL and ensure the model is Published publicly.";
            startButton.disabled = true;
        }
    }

    // Hàm khởi động Webcam (Chỉ chạy khi nhấn nút)
    async function startWebcam() {
        if (!isModelLoaded) return;
        
        statusMessage.innerText = "Starting webcam...";
        startButton.disabled = true; // Disable button while starting

        try {
            const flip = true; 
            webcam = new tmImage.Webcam(320, 240, flip);
            await webcam.setup(); // Request camera permission
            await webcam.play();

            document.getElementById("webcam-container").appendChild(webcam.canvas);
            
            labelContainer.innerText = "Detecting...";
            
            statusMessage.style.display = 'none'; // Hide status message
            startButton.style.display = 'none'; // Hide start button
            
            // Start the detection loop
            window.requestAnimationFrame(loop);

        } catch (error) {
            console.error("ERROR STARTING CAMERA:", error); // Log specific error
            statusMessage.style.display = 'block';
            statusMessage.innerText = "ERROR: Could not start camera. Please check: 1. Did you click 'Allow' for camera access? 2. Does your browser support the camera?";
            startButton.disabled = false;
            startButton.style.display = 'block';
        }
    }


    async function loop() {
        if (!isModelLoaded || !webcam) return;
        
        webcam.update();
        await predict();
        window.requestAnimationFrame(loop);
    }

    async function predict() {
        const prediction = await model.predict(webcam.canvas);
        let topPrediction = null;

        // Find the class with the highest probability
        for (let i = 0; i < maxPredictions; i++) {
            if (topPrediction === null || prediction[i].probability > topPrediction.probability) {
                topPrediction = prediction[i];
            }
        }
        
        // Display the detected object name and update the variable for Gemini
        if (topPrediction !== null) {
            currentDetectedObject = topPrediction.className; 
            labelContainer.innerText = currentDetectedObject; 
            generateButton.disabled = false;
        }
    }
    
    // Hàm gọi Gemini API - Đã cập nhật để bao gồm cả hướng dẫn an toàn
    async function generateExplanation() {
        if (!currentDetectedObject || currentDetectedObject === '-- NOT STARTED --' || currentDetectedObject === 'Detecting...' || currentDetectedObject === '-- Ready --') {
            geminiResultContainer.innerHTML = '<p class="gemini-error">Please detect an object first.</p>';
            return;
        }

        geminiResultContainer.innerHTML = '<p class="gemini-loading">Querying Gemini... (Searching for information)</p>';
        generateButton.disabled = true;
        generateButton.innerText = "Loading...";

        // Cập nhật System Prompt: Ngôn ngữ tiếng Anh, cấp độ THCS (Middle School)
        const systemPrompt = "You are a friendly and knowledgeable Middle School (Grade 7-8) STEAM Lab Assistant. Your task is to provide a concise, engaging, and easy-to-read response (in English only) about the object the student is researching. Your response must include: 1. A very short explanation (one sentence, use bold formatting). 2. If it is a tool or lab equipment, provide 3-5 basic safety usage bullet points relevant to a Makerspace or Lab (use bullet list). 3. If it is NOT a tool, suggest one simple, relevant STEAM project or application idea instead (use bold formatting for the project name). Keep the tone encouraging and brief.";
        const userQuery = `Explain "${currentDetectedObject}" and provide safety usage guidelines (if a tool) or suggest a simple STEAM project (if not a tool).`;

        const payload = {
            contents: [{ parts: [{ text: userQuery }] }],
            tools: [{ "google_search": {} }],
            systemInstruction: {
                parts: [{ text: systemPrompt }]
            },
        };

        try {
            const response = await fetchWithExponentialBackoff(geminiApiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            const candidate = result.candidates?.[0];

            if (candidate && candidate.content?.parts?.[0]?.text) {
                const markdownText = candidate.content.parts[0].text;
                
                // CHUYỂN ĐỔI MARKDOWN SANG HTML SỬ DỤNG Marked.js
                const htmlContent = marked.parse(markdownText);
                
                // Extract sources
                let sourcesHtml = '';
                const groundingMetadata = candidate.groundingMetadata;
                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    const sources = groundingMetadata.groundingAttributions
                        .map(attribution => ({
                            uri: attribution.web?.uri,
                            title: attribution.web?.title,
                        }))
                        .filter(source => source.uri && source.title);

                    if (sources.length > 0) {
                        sourcesHtml = '<div class="gemini-sources">References: ';
                        sourcesHtml += sources.slice(0, 3).map(s => `<a href="${s.uri}" target="_blank">${s.title}</a>`).join(', ');
                        sourcesHtml += '</div>';
                    }
                }
                
                // Chèn nội dung HTML đã được định dạng
                geminiResultContainer.innerHTML = `<div class="gemini-response">${htmlContent}</div>${sourcesHtml}`;

            } else {
                geminiResultContainer.innerHTML = '<p class="gemini-error">Gemini failed to generate a response.</p>';
            }

        } catch (error) {
            console.error("Gemini API Error:", error);
            geminiResultContainer.innerHTML = '<p class="gemini-error">API connection error. Please try again later.</p>';
        } finally {
            generateButton.disabled = false;
            generateButton.innerText = "✨ Get Info & Safety Guide";
        }
    }


    // Tải mô hình khi trang web tải xong
    window.onload = loadModel; 
</script>
